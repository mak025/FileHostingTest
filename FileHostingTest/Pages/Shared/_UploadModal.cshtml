@model FileHostingTest.Pages.FileStorageTestModel

<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadModalLabel">Upload file</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- Note: the form posts to OnPostUploadAsync in the PageModel. The hidden 'path' input keeps current folder. -->
        <form method="post" enctype="multipart/form-data" asp-page-handler="Upload" id="uploadForm">
            <input type="hidden" name="view" value="list" />
            <input type="hidden" name="path" id="modalPathInput" value="@Model.Path" />

            <div class="mb-3 text-center">
                <button type="button" class="btn btn-outline-secondary" id="browseButton">Browse files</button>
                <input type="file" name="Upload" id="modalFileInput" class="d-none" />
            </div>

            <div id="modalDropzone" class="dropzone">
                <div class="dropzone-content">
                    <div class="drop-icon">??</div>
                    <div class="drop-text">Choose a file or drag it here.</div>
                    <div class="drop-filename text-muted" id="dropFileName"></div>
                </div>
            </div>

            <div class="mt-3">
                <div class="progress" style="height:10px; display:none;" id="uploadProgress">
                    <div class="progress-bar" role="progressbar" style="width:0%"></div>
                </div>
            </div>

            <div class="mt-3 text-end">
                <!-- Use JS to submit via AJAX so we can show progress. Falls back to normal submit if JS disabled. -->
                <button type="button" class="btn btn-primary" id="modalUploadButton">Upload</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            var myDropzone = new Dropzone("#modalDropzone", {
                url: "@Url.Page(null, "Upload")",
                paramName: "Upload", // The name that will be used to transfer the file
                maxFilesize: 2, // MB
                autoProcessQueue: false,
                init: function () {
                    var myDropzone = this;

                    // Handle the upload button click
                    $("#modalUploadButton").click(function () {
                        // If there are files to upload
                        if (myDropzone.files.length > 0) {
                            // Get the CSRF token from the form
                            var token = $("input[name='__RequestVerificationToken']").val();

                            // Create a FormData object
                            var formData = new FormData();

                            // Append the file to the FormData object
                            formData.append("Upload", myDropzone.files[0]);

                            // Append the path and view
                            formData.append("path", $("#modalPathInput").val());
                            formData.append("view", "list");

                            // Show the progress bar
                            $("#uploadProgress").show();

                            // Make the AJAX request
                            $.ajax({
                                url: "@Url.Page(null, "Upload")",
                                type: "POST",
                                data: formData,
                                contentType: false,
                                processData: false,
                                headers: {
                                    'X-CSRF-TOKEN': token // Add the CSRF token to the request
                                },
                                xhr: function () {
                                    var xhr = new window.XMLHttpRequest();

                                    // Upload progress
                                    xhr.upload.addEventListener("progress", function (evt) {
                                        if (evt.lengthComputable) {
                                            var percentComplete = (evt.loaded / evt.total) * 100;
                                            // Update the progress bar width
                                            $(".progress-bar").css("width", percentComplete + "%");
                                        }
                                    }, false);

                                    return xhr;
                                },
                                success: function (result) {
                                    // Handle success (e.g., close the modal, update the file list)
                                    $("#uploadModal").modal("hide");
                                    // Optionally, refresh the file list or show a success message
                                },
                                error: function (jqXHR, textStatus, errorThrown) {
                                    // Handle error
                                    alert("An error occurred while uploading the file. Please try again.");
                                },
                                complete: function () {
                                    // Hide the progress bar when done
                                    $("#uploadProgress").hide();
                                    // Remove the file from Dropzone queue
                                    myDropzone.removeAllFiles();
                                }
                            });
                        } else {
                            alert("Please select a file to upload.");
                        }
                    });

                    // Handle file selection
                    $("#modalFileInput").on("change", function () {
                        // Get the selected file name
                        var fileName = $(this).val().split("\\").pop();

                        // Update the dropzone text and filename
                        $("#dropFileName").text(fileName);
                        $("#modalDropzone .drop-text").text(fileName);
                    });
                }
            });

            // Browse button click
            $("#browseButton").click(function () {
                $("#modalFileInput").click();
            });
        });
    </script>
}